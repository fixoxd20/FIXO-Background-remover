<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Showcase</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="antialiased">
    <!-- Main application container -->
    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header Section -->
        <header class="text-center my-8 md:my-12 space-y-2">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight tracking-tight">
                Community Showcase
            </h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                A place for the owner to share creations with the community.
            </p>
            <p class="text-xs text-gray-500">
                Your User ID: <code id="userIdDisplay" class="bg-gray-200 px-2 py-1 rounded font-mono">Loading...</code>
            </p>
            <p id="ownerStatus" class="text-green-600 font-semibold mt-2 hidden">
                You are the Owner. Use the form below to add new content.
            </p>
        </header>

        <!-- Owner's Post Form (initially hidden) -->
        <section id="ownerFormSection" class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8 hidden">
            <h2 class="text-2xl font-bold mb-6 text-gray-900">Add New Content</h2>
            <form id="postForm" class="space-y-4">
                <div>
                    <label for="postTitle" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="postTitle" placeholder="Enter title" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="postDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="postDescription" placeholder="Enter a brief description" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" required></textarea>
                </div>
                <div>
                    <label for="zipUrl" class="block text-sm font-medium text-gray-700 mb-1">Zip File URL</label>
                    <input type="url" id="zipUrl" placeholder="e.g., https://example.com/file.zip" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="imageUrl" class="block text-sm font-medium text-gray-700 mb-1">Preview Image URL</label>
                    <input type="url" id="imageUrl" placeholder="e.g., https://example.com/image.jpg" class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 text-white font-semibold py-3 rounded-xl hover:bg-green-700 transition-colors shadow-md">
                    Publish Post
                </button>
            </form>
        </section>

        <!-- Posts Display Section -->
        <section id="postsContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div id="loading" class="col-span-full text-center py-20">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-4 text-lg text-gray-600">Loading posts...</p>
            </div>
            <div id="noPosts" class="col-span-full text-center py-20 bg-white rounded-2xl shadow-lg hidden">
                <p class="text-gray-500 text-xl">No posts found. Add one using the form above!</p>
            </div>
        </section>
    </div>

    <!-- Modal for messages and alerts -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full text-center space-y-4">
            <h3 class="text-xl font-semibold text-gray-800">Notification</h3>
            <p id="modalMessage" class="text-gray-600"></p>
            <button id="modalClose" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                Close
            </button>
        </div>
    </div>

    <!-- HTML Template for a single post card -->
    <template id="postTemplate">
        <div class="post-card bg-white rounded-2xl shadow-xl overflow-hidden transform transition-transform duration-300 hover:scale-[1.02] border border-gray-200">
            <div class="relative">
                <img class="post-image w-full h-64 object-cover" src="https://placehold.co/600x400/E5E7EB/4B5563?text=No+Image" alt="Post preview">
                <div class="post-date absolute top-4 right-4 bg-gray-900 text-white text-xs font-bold px-3 py-1 rounded-full opacity-90"></div>
            </div>
            <div class="p-6 space-y-4">
                <h2 class="post-title text-2xl font-bold text-gray-900"></h2>
                <p class="post-description text-gray-600 leading-relaxed"></p>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <span class="font-semibold">Owner ID:</span>
                    <code class="post-ownerId bg-gray-100 p-1 rounded text-xs font-mono"></code>
                </div>
                <a class="download-link w-full flex items-center justify-center bg-blue-600 text-white font-semibold py-3 rounded-xl hover:bg-blue-700 transition-colors shadow-lg" href="#" download>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 11.586V3a1 1 0 112 0v8.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download Zip File
                </a>
                <div class="reaction-buttons flex items-center space-x-4 border-t border-gray-200 pt-4">
                    <!-- Reactions will be added here by JS -->
                </div>
            </div>
            <div class="p-6 bg-gray-50 border-t border-gray-200 space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">Comments</h3>
                <div class="comments-container space-y-3 max-h-48 overflow-y-auto pr-2">
                    <!-- Comments will be added here by JS -->
                </div>
                <form class="comment-form mt-4 flex space-x-2">
                    <input type="text" class="comment-input flex-grow p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Add a comment..." required>
                    <button type="submit" class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition-colors shadow-md">
                        Post
                    </button>
                </form>
            </div>
        </div>
    </template>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const ownerId = 'demo-owner-id-123'; // Hardcoded owner ID for demonstration purposes

        const elements = {
            app: document.getElementById('app'),
            userIdDisplay: document.getElementById('userIdDisplay'),
            ownerStatus: document.getElementById('ownerStatus'),
            ownerFormSection: document.getElementById('ownerFormSection'),
            postForm: document.getElementById('postForm'),
            postTitle: document.getElementById('postTitle'),
            postDescription: document.getElementById('postDescription'),
            zipUrl: document.getElementById('zipUrl'),
            imageUrl: document.getElementById('imageUrl'),
            postsContainer: document.getElementById('postsContainer'),
            loading: document.getElementById('loading'),
            noPosts: document.getElementById('noPosts'),
            modal: document.getElementById('modal'),
            modalMessage: document.getElementById('modalMessage'),
            modalClose: document.getElementById('modalClose'),
            postTemplate: document.getElementById('postTemplate'),
        };

        // Function to show a custom modal message
        function showModal(message) {
            elements.modalMessage.textContent = message;
            elements.modal.classList.remove('hidden');
        }

        // Initialize Firebase services
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showModal("Failed to initialize the app. Please check the console for details.");
            }
        }

        // Set up authentication and UI based on user state
        function setupAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    elements.userIdDisplay.textContent = userId;
                    if (userId === ownerId) {
                        elements.ownerFormSection.classList.remove('hidden');
                        elements.ownerStatus.classList.remove('hidden');
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (e) {
                        console.error("Error signing in anonymously:", e);
                    }
                }
            });
        }

        // Listen for real-time post updates
        function listenForPosts() {
            if (!db) return;

            const postsCollectionPath = `artifacts/${appId}/public/data/posts`;
            const q = collection(db, postsCollectionPath);

            onSnapshot(q, async (querySnapshot) => {
                const posts = [];
                for (const docSnapshot of querySnapshot.docs) {
                    const postData = docSnapshot.data();
                    const post = { id: docSnapshot.id, ...postData };
                    posts.push(post);
                }
                posts.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderPosts(posts);
            }, (error) => {
                console.error("Error fetching posts:", error);
                showModal("Error fetching posts. Please try again.");
            });
        }

        // Render posts from the fetched data
        function renderPosts(posts) {
            elements.postsContainer.innerHTML = '';
            elements.loading.classList.add('hidden');
            if (posts.length === 0) {
                elements.noPosts.classList.remove('hidden');
            } else {
                elements.noPosts.classList.add('hidden');
            }

            posts.forEach(post => {
                const postCard = elements.postTemplate.content.cloneNode(true).firstElementChild;
                postCard.setAttribute('data-id', post.id);

                // Set post details
                postCard.querySelector('.post-title').textContent = post.title;
                postCard.querySelector('.post-description').textContent = post.description;
                postCard.querySelector('.download-link').href = post.zipUrl;
                postCard.querySelector('.post-image').src = post.imageUrl;
                postCard.querySelector('.post-ownerId').textContent = post.ownerId;
                if (post.createdAt) {
                    postCard.querySelector('.post-date').textContent = new Date(post.createdAt.toMillis()).toLocaleDateString();
                }

                const reactionsContainer = postCard.querySelector('.reaction-buttons');
                const reactionIcons = { '👍': '👍', '❤️': '❤️', '😂': '😂' };
                Object.entries(reactionIcons).forEach(([reaction, icon]) => {
                    const count = post.reactions?.[reaction]?.length || 0;
                    const userHasReacted = post.reactions?.[reaction]?.includes(userId) ?? false;
                    const button = document.createElement('button');
                    button.innerHTML = `<span class="text-xl">${icon}</span> <span class="font-semibold">${count}</span>`;
                    button.className = `flex items-center space-x-1 p-2 rounded-full transition-colors ${userHasReacted ? 'bg-blue-100 text-blue-600' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`;
                    button.onclick = () => handleReaction(post.id, reaction);
                    reactionsContainer.appendChild(button);
                });

                // Listen for comments for this post
                const commentsContainer = postCard.querySelector('.comments-container');
                const commentsCollectionPath = `artifacts/${appId}/public/data/posts/${post.id}/comments`;
                const commentsQuery = query(collection(db, commentsCollectionPath), orderBy('createdAt', 'desc'), limit(50));
                onSnapshot(commentsQuery, (commentsSnapshot) => {
                    commentsContainer.innerHTML = '';
                    if (commentsSnapshot.empty) {
                        commentsContainer.innerHTML = '<p class="text-sm text-gray-500 italic">No comments yet. Be the first to add one!</p>';
                    } else {
                        commentsSnapshot.forEach(commentDoc => {
                            const comment = commentDoc.data();
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'bg-gray-100 p-3 rounded-lg';
                            commentDiv.innerHTML = `<p class="text-sm text-gray-700 leading-snug">${comment.text}</p><p class="text-xs text-gray-500 mt-1">User: <code class="font-mono">${comment.userId}</code></p>`;
                            commentsContainer.appendChild(commentDiv);
                        });
                    }
                }, (error) => {
                    console.error("Error fetching comments for post:", post.id, error);
                });

                // Add event listener for comment form
                const commentForm = postCard.querySelector('.comment-form');
                commentForm.onsubmit = (e) => {
                    e.preventDefault();
                    const input = e.target.querySelector('.comment-input');
                    if (input.value.trim()) {
                        handleAddComment(post.id, input.value);
                        input.value = '';
                    }
                };
                
                elements.postsContainer.appendChild(postCard);
            });
        }

        // Handle the owner's post submission
        async function handleAddPost(e) {
            e.preventDefault();
            if (!db || userId !== ownerId) {
                showModal("You must be the owner to add a post.");
                return;
            }

            const newPost = {
                title: elements.postTitle.value,
                description: elements.postDescription.value,
                zipUrl: elements.zipUrl.value,
                imageUrl: elements.imageUrl.value,
                reactions: {},
                createdAt: serverTimestamp(),
                ownerId: userId
            };

            const postsCollectionPath = `artifacts/${appId}/public/data/posts`;
            try {
                await addDoc(collection(db, postsCollectionPath), newPost);
                elements.postForm.reset();
                showModal("Post added successfully!");
            } catch (e) {
                console.error("Error adding document:", e);
                showModal("Failed to add post. Please try again.");
            }
        }

        // Handle a user reaction
        async function handleReaction(postId, reactionType) {
            if (!db || !userId) return;

            const postDocRef = doc(db, `artifacts/${appId}/public/data/posts/${postId}`);
            const post = document.querySelector(`.post-card[data-id="${postId}"]`);
            if (!post) return;

            // Optimistic UI update
            const reactionButton = post.querySelector(`.reaction-buttons button:nth-of-type(${Object.keys({'👍': 1, '❤️': 2, '😂': 3}).indexOf(reactionType) + 1})`);
            const countSpan = reactionButton.querySelector('span:last-of-type');
            
            // Get current state from the DOM to avoid race conditions
            let currentCount = parseInt(countSpan.textContent);
            let isCurrentlyReacted = reactionButton.classList.contains('bg-blue-100');
            
            if (isCurrentlyReacted) {
                reactionButton.classList.remove('bg-blue-100', 'text-blue-600');
                reactionButton.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                countSpan.textContent = currentCount > 0 ? currentCount - 1 : 0;
            } else {
                // Before reacting, un-react from other reactions on this post
                post.querySelectorAll('.reaction-buttons button').forEach(button => {
                    if (button.classList.contains('bg-blue-100')) {
                        const otherCountSpan = button.querySelector('span:last-of-type');
                        const otherCount = parseInt(otherCountSpan.textContent);
                        button.classList.remove('bg-blue-100', 'text-blue-600');
                        button.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                        otherCountSpan.textContent = otherCount > 0 ? otherCount - 1 : 0;
                    }
                });
                
                reactionButton.classList.add('bg-blue-100', 'text-blue-600');
                reactionButton.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                countSpan.textContent = currentCount + 1;
            }

            // Update Firestore with the new reaction
            try {
                const docSnap = await getDoc(postDocRef);
                if (docSnap.exists()) {
                    const postData = docSnap.data();
                    const newReactions = { ...postData.reactions };
                    if (!newReactions[reactionType]) {
                        newReactions[reactionType] = [];
                    }

                    const hasReacted = newReactions[reactionType].includes(userId);
                    if (hasReacted) {
                        newReactions[reactionType] = newReactions[reactionType].filter(uid => uid !== userId);
                    } else {
                        // Remove user's ID from all other reaction lists
                        Object.keys(newReactions).forEach(key => {
                            newReactions[key] = newReactions[key].filter(uid => uid !== userId);
                        });
                        newReactions[reactionType].push(userId);
                    }
                    await updateDoc(postDocRef, { reactions: newReactions });
                }
            } catch (e) {
                console.error("Error updating reaction:", e);
                showModal("Failed to update reaction. Please try again.");
            }
        }

        // Handle adding a comment
        async function handleAddComment(postId, commentText) {
            if (!db || !userId) {
                showModal("You must be logged in to comment.");
                return;
            }

            const commentsCollectionPath = `artifacts/${appId}/public/data/posts/${postId}/comments`;
            const newComment = {
                text: commentText,
                userId: userId,
                createdAt: serverTimestamp(),
            };

            try {
                await addDoc(collection(db, commentsCollectionPath), newComment);
            } catch (e) {
                console.error("Error adding comment:", e);
                showModal("Failed to add comment. Please try again.");
            }
        }

        // Event listener for modal close button
        elements.modalClose.addEventListener('click', () => {
            elements.modal.classList.add('hidden');
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupAuth();
            listenForPosts();
            elements.postForm.addEventListener('submit', handleAddPost);
        });
    </script>
</body>
</html>
